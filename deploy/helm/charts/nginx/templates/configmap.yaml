apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "nginx.fullname" . }}-config
data:
  {{- with .Values.imageConfigMaps }}
  NGINX.CONF: |
    user  nginx;
    worker_processes auto;

    error_log  /var/log/nginx/error.log notice;
    pid        /var/run/nginx.pid;

    events {
        worker_connections  {{ .workerConnections | default "1024" }};
    }

    http {
        include       /etc/nginx/mime.types;
        default_type  application/octet-stream;

        log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for"';

        access_log  /var/log/nginx/access.log  main;

        sendfile        on;
        #tcp_nopush     on;

        keepalive_timeout  {{ .keepaliveTimeout | default "65" }};
        client_max_body_size 100M;
        client_body_timeout 300s;
        send_timeout 300s;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;

        proxy_buffer_size 128k;
        proxy_buffers 8 256k;
        proxy_busy_buffers_size 256k;

        gzip  on;

        include /etc/nginx/conf.d/upstream.conf;
        include /etc/nginx/conf.d/public.conf;
        include /etc/nginx/conf.d/log.conf;
    }
  LOG.CONF: |
    log_format json '{'
               '"time":"$time_iso8601",'
               '"remote_addr":"$remote_addr",'
               '"request":"$request",'
               '"request_method":"$request_method",'
               '"request_length":"$request_length",'
               '"request_uri":"$request_uri",'
               '"uri":"$uri",'
               '"query_string":"$query_string",'
               '"status":"$status",'
               '"bytes_sent":"$bytes_sent",'
               '"body_bytes_sent":"$body_bytes_sent",'
               '"referer":"$http_referer",'
               '"useragent":"$http_user_agent",'
               '"forwardedfor":"$http_x_forwarded_for",'
               '"request_time":"$request_time",'
               '"upstream_response_time":"$upstream_response_time"'
              '}';
  UPSTREAM.CONF: |
    upstream django {
        server web:8000;
    }
  {{- end }}
  PUBLIC.CONF: |
    server {
        listen          {{ .Values.service.port | default "80" }} default_server;
        server_name     $host www.$host;
        charset         utf-8;

        client_max_body_size 100M;

        location / {
            proxy_pass http://django;
            proxy_http_version 1.1;
            proxy_set_header Connection "";

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Timeout configurations for heavy API requests
            proxy_read_timeout 300s;
            proxy_send_timeout 300s;
            proxy_connect_timeout 300s;

            # CORS (에러 응답에도 적용)
            add_header Access-Control-Allow-Origin "*" always;
        }

        location /nginx-healthz/ {
            access_log off;
            return 200 'ok';
            add_header Content-Type text/plain;
        }

        location /static/ {
            alias /django/static/;
        }

        location /media/ {
            alias /django/media/;
        }
    }

    server_tokens off;
