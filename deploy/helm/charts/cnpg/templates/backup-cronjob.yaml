{{- if and .Values.enabled .Values.backup.nfs.enabled (eq .Values.global.appMode "prod") }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "cnpg.fullname" . }}-backup
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "cnpg.labels" . | nindent 4 }}
spec:
  schedule: {{ .Values.backup.schedule | default "0 2 * * *" | quote }}
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 600  # Delete a backup job 10 minutes after completion
      template:
        metadata:
          labels:
            {{- include "cnpg.labels" . | nindent 12 }}
            app.kubernetes.io/component: backup
        spec:
          restartPolicy: OnFailure
          automountServiceAccountToken: false
          containers:
            - name: postgres-backup
              image: {{ include "cnpg.image" . }}
              imagePullPolicy: {{ .Values.image.pullPolicy | default "IfNotPresent" }}
              command:
                - /bin/bash
                - -c
                - |
                  set -eu

                  # CloudNativePG í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
                  DATE=$(date +"%Y-%m-%d-%H%M%S")
                  DUMP_FILE=/var/backups/ibs-backup-postgres-${DATE}.dump
                  POSTGRES_SCHEMA="{{ .Values.auth.database }}"
                  POSTGRES_DATABASE="{{ .Values.auth.database }}"
                  POSTGRES_USER="postgres"
                  POSTGRES_PASSWORD=$(cat /run/secrets/postgres-password)
                  PSQL_HOST="{{ include "cnpg.clusterName" . }}-rw"

                  # postgres ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ë° ë™ê¸°í™”
                  echo "ðŸ”‘ Verifying postgres password..."
                  if ! PGPASSWORD="$POSTGRES_PASSWORD" psql -h "$PSQL_HOST" -U "$POSTGRES_USER" -d "$POSTGRES_DATABASE" -c "SELECT 1;" > /dev/null 2>&1; then
                      echo "âš ï¸  Password mismatch detected, synchronizing..."
                      # Pod ë‚´ë¶€ì—ì„œëŠ” postgres ì‚¬ìš©ìžë¡œ ì§ì ‘ ì ‘ê·¼ ê°€ëŠ¥
                      if psql -U postgres -c "ALTER USER postgres WITH PASSWORD '$POSTGRES_PASSWORD';" > /dev/null 2>&1; then
                          echo "âœ… Password synchronized successfully"
                          sleep 2
                          # ìž¬í™•ì¸
                          if ! PGPASSWORD="$POSTGRES_PASSWORD" psql -h "$PSQL_HOST" -U "$POSTGRES_USER" -d "$POSTGRES_DATABASE" -c "SELECT 1;" > /dev/null 2>&1; then
                              echo "âŒ Password verification failed after update"
                              exit 1
                          fi
                      else
                          echo "âŒ Failed to update postgres password"
                          exit 1
                      fi
                  else
                      echo "âœ… Password verified"
                  fi

                  # ì´ì „ ë°±ì—… ì‚­ì œ (2ì¼ ì´ìƒëœ íŒŒì¼)
                  find /var/backups \( -name "*.dump" -o -name "*.log" \) -type f -mtime +2 -delete

                  if [ -f "$DUMP_FILE" ]; then
                      rm "$DUMP_FILE"
                  fi

                  echo "Starting PostgreSQL backup: ${DUMP_FILE}"

                  # pg_dumpë¡œ ë°±ì—… ì‹¤í–‰
                  PGPASSWORD="$POSTGRES_PASSWORD" pg_dump \
                    -h "$PSQL_HOST" \
                    -U "$POSTGRES_USER" \
                    -d "$POSTGRES_DATABASE" \
                    -n "$POSTGRES_SCHEMA" \
                    --data-only \
                    --exclude-table="${POSTGRES_SCHEMA}.django_migrations" \
                    --column-inserts \
                    -Fc \
                    -f "$DUMP_FILE"

                  # í¼ë¯¸ì…˜ ë³€ê²½
                  chmod 644 ${DUMP_FILE}

                  # ë°±ì—… ì„±ê³µ í™•ì¸
                  if [ $? -eq 0 ]; then
                      echo "PostgreSQL Backup completed successfully: ${DUMP_FILE}"
                      ls -lh "$DUMP_FILE"
                  else
                      echo "PostgreSQL Backup failed." >&2
                      exit 1
                  fi
              volumeMounts:
                - name: backup-volume
                  mountPath: /var/backups
                - name: postgres-password
                  mountPath: /run/secrets
                  readOnly: true
          volumes:
            - name: backup-volume
              persistentVolumeClaim:
                claimName: {{ include "cnpg.fullname" . }}-backup-{{ .Values.global.appMode }}-pvc
            - name: postgres-password
              secret:
                secretName: {{ include "cnpg.fullname" . }}-superuser
                items:
                  - key: password
                    path: postgres-password
{{- end }}