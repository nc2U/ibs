name: Vue [Prod]

on:
  push:
    paths:
      - "app/vue/**"
      - ".github/workflows/vue_prod.yml"
    branches: [ "master" ]
  
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# jobì€ ì‚¬ìš©ìê°€ ì •í•œ í”Œë«í¼ì„ í†µí•´ steps ë¼ëŠ” ì¼ë ¨ì˜ ê³¼ì •ì„ ì‹¤í–‰.
# ì—¬ëŸ¬ ê°œì˜ job ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë©°, ì—¬ëŸ¬ ê°œì˜ job ì„ ì‚¬ìš©í•  ë•ŒëŠ” ì„œë¡œ ì •ë³´ë„ êµí™˜ ê°€ëŠ¥.
# ê°ê° ë…ë¦½ì ìœ¼ë¡œë„ ì‹¤í–‰ ê°€ëŠ¥.
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    
    steps:
      # ë ˆíŒŒì§€í„°ë¦¬ ì²´í¬ ì•„ì›ƒ
      - name: Check out source code
        uses: actions/checkout@v4
      
      # Node.js ì‚¬ìš©
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 24
      
      # pnpm use
      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 10
          run_install: false
      
      # node_modules ìºì‹±
      - name: Cache vue node
        uses: actions/cache@v3
        id: cache_vue
        with:
          path: ./app/vue/node_modules
          key: pnpm-packages-${{ hashFiles('**/pnpm-lock.yaml') }}
      
      # node_modules ë³€í™”ê¸° ìˆìœ¼ë©´ ë¹Œë“œ
      - name: Install Dependencies
        if: steps.cache_vue.outputs.cache-hit != 'true'
        run: cd app/vue && pnpm i
      
      #      - run: pnpm lint
      #        # `if: ${{ always() }}`
      #        # ë§Œì•½ `pnpm lint`ë¼ëŠ” ê³³ì—ì„œ ì—ëŸ¬ê°€ ë‚¬ì„ ê²½ìš° ì´í›„ buildë¥¼ ì‹¤í–‰í•˜ì§€ ì•Šê³  í•´ë‹¹ workflowê°€ ì¢…ë£Œë¨.
      #        # `if: ${{ always() }}`ë¼ëŠ” ë¬¸ë²•ì„ ì‚¬ìš© ì‹œ `pnpm lint`ë¼ëŠ” ê³³ì—ì„œ ì—ëŸ¬ê°€ ë‚˜ë„
      #        # ì´í›„ì˜ buildê¹Œì§€ ë‹¤ ì‹¤í–‰ì„ í•´ë³´ê³  ë‚œ ë’¤ ì¢…ë£Œ í•˜ë¯€ë¡œ ëª¨ë“  í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ì— `if: ${{ always() }}`ë¥¼ ë¶™ì„.
      #        if: ${{ always() }}
      
      # setup and lint ì—ëŸ¬ê°€ ì—†ìœ¼ë©´ ë¹Œë“œ
      - name: Build the Source Code
        env:
          NODE_ENV: production
          BUILD_TIMESTAMP: ${{ github.run_number }}_${{ github.sha }}
        run: |
          cd app/vue
          # íƒ€ì„ìŠ¤íƒ¬í”„ ë””ë ‰í„°ë¦¬ë¡œ ë¹Œë“œ
          export BUILD_DIR="../django/static/dist_${BUILD_TIMESTAMP}"
          pnpm build && pnpm docs:build

      # ë°°í¬ ë©”íƒ€ë°ì´í„° ìƒì„±
      - name: Create deployment metadata
        env:
          BUILD_TIMESTAMP: ${{ github.run_number }}_${{ github.sha }}
        run: |
          cd app/django/static
          echo "{
            \"build_time\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
            \"git_sha\": \"${{ github.sha }}\",
            \"git_branch\": \"${{ github.ref_name }}\",
            \"build_number\": \"${{ github.run_number }}\",
            \"deployer\": \"${{ github.actor }}\"
          }" > dist_${BUILD_TIMESTAMP}/deploy.json

      # ë¹Œë“œ ê²€ì¦
      - name: Verify Production Build
        env:
          BUILD_TIMESTAMP: ${{ github.run_number }}_${{ github.sha }}
        run: |
          cd app/django/static/dist_${BUILD_TIMESTAMP}

          echo "ğŸ” Verifying production build..."

          # index.html ì¡´ì¬ í™•ì¸
          if [ ! -f "index.html" ]; then
            echo "âŒ ERROR: index.html not found!"
            exit 1
          fi

          # base path ê²€ì¦ (/static/dist ê²½ë¡œ ì‚¬ìš© í™•ì¸)
          if ! grep -q '/static/dist/assets/' index.html; then
            echo "âŒ ERROR: Build base path incorrect! Expected '/static/dist/assets/'"
            echo "Found paths:"
            grep -o 'src="[^"]*"' index.html | head -5
            exit 1
          fi

          # console.log ì œê±° í™•ì¸ (ê²½ê³ ë§Œ)
          if find assets -name "*.js" -exec grep -l 'console\.log' {} \; 2>/dev/null | grep -q .; then
            echo "âš ï¸  WARNING: Console logs found in production build"
          fi

          # sourcemap ì œì™¸ í™•ì¸ (ê²½ê³ ë§Œ)
          if find assets -name "*.map" 2>/dev/null | grep -q .; then
            echo "âš ï¸  WARNING: Sourcemap files found in production build"
          fi

          echo "âœ… Production build verification passed"
          echo "ğŸ“Š Build stats:"
          echo "  - index.html: $(wc -c < index.html) bytes"
          echo "  - Total assets: $(find assets -type f | wc -l) files"
          echo "  - Total size: $(du -sh assets | cut -f1)"

      # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
      - name: Vue Unit Test using Vitest
        run: cd app/vue && pnpm test:unit

      # docs ë°°í¬
      - name: Docs Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: app/vue/docs/.vitepress/dist

      # ìƒˆ ë¹Œë“œë§Œ ì—…ë¡œë“œ (ì „ì²´ staticì´ ì•„ë‹Œ)
      - name: Upload new build to server
        env:
          BUILD_TIMESTAMP: ${{ github.run_number }}_${{ github.sha }}
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.CICD_HOST }}
          username: ${{ secrets.CICD_USER }}
          password: ${{ secrets.CICD_PASS }}
          source: 'app/django/static/dist_${{ github.run_number }}_${{ github.sha }}'
          target: ${{ secrets.CICD_PATH }}/prod/app/django/static/

      # ì›ìì  ë°°í¬ (Symlink Swap)
      - name: Atomic deployment with symlink swap
        env:
          BUILD_TIMESTAMP: ${{ github.run_number }}_${{ github.sha }}
        uses: garygrossgarten/github-action-ssh@release
        with:
          host: ${{ secrets.CICD_HOST }}
          username: ${{ secrets.CICD_USER }}
          password: ${{ secrets.CICD_PASS }}
          command: |
            cd ${{ secrets.CICD_PATH }}/prod/app/django/static

            # ìƒˆ ë¹Œë“œ ë””ë ‰í„°ë¦¬ëª…
            NEW_BUILD="dist_${{ github.run_number }}_${{ github.sha }}"

            echo "ğŸ“¦ New build: $NEW_BUILD"

            # ì‹¬ë³¼ë¦­ ë§í¬ ì›ìì  êµì²´
            ln -sfn "$NEW_BUILD" dist.tmp
            mv -Tf dist.tmp dist

            # ì˜¤ë˜ëœ ë¹Œë“œ ì •ë¦¬ (ìµœê·¼ 2ê°œë§Œ ìœ ì§€: í˜„ì¬ + ì´ì „)
            echo "ğŸ§¹ Cleaning old builds..."
            ls -dt dist_* 2>/dev/null | tail -n +3 | xargs -r rm -rf

            echo "âœ… Deployed: $NEW_BUILD"
            echo "ğŸ“Š Remaining builds:"
            ls -lth | grep "^d" | grep "dist_" | head -3

      # NFS ë™ê¸°í™” ëŒ€ê¸°
      - name: Wait for NFS sync
        run: |
          echo "â³ Waiting for NFS synchronization..."
          sleep 5
          echo "âœ… NFS sync complete"

      # ë°°í¬ ê²€ì¦
      - name: Verify deployment
        uses: garygrossgarten/github-action-ssh@release
        with:
          host: ${{ secrets.CICD_HOST }}
          username: ${{ secrets.CICD_USER }}
          password: ${{ secrets.CICD_PASS }}
          command: |
            cd ${{ secrets.CICD_PATH }}/prod/app/django/static

            # index.html ì¡´ì¬ í™•ì¸
            if [ ! -f "dist/index.html" ]; then
              echo "âŒ Deployment failed: index.html not found"
              exit 1
            fi

            # ë°°í¬ ì •ë³´ ì¶œë ¥
            echo "âœ… Deployment verified"
            if [ -f "dist/deploy.json" ]; then
              cat dist/deploy.json
            fi

      # Kubernetes Pod ì¬ì‹œì‘ (Django í…œí”Œë¦¿ ìºì‹œ í´ë¦¬ì–´)
      - name: Restart web and nginx pods
        uses: garygrossgarten/github-action-ssh@release
        with:
          host: ${{ secrets.CICD_HOST }}
          username: ${{ secrets.CICD_USER }}
          password: ${{ secrets.CICD_PASS }}
          command: |
            echo "ğŸ”„ Restarting Nginx and Web pods..."
            kubectl rollout restart deployment/nginx -n ibs-prod
            kubectl rollout restart deployment/web -n ibs-prod

            echo "â³ Waiting for rollout to complete..."
            kubectl rollout status deployment/nginx -n ibs-prod --timeout=120s
            kubectl rollout status deployment/web -n ibs-prod --timeout=120s

            echo "âœ… Pods restarted successfully"

      # web pod --> fetch_commits
      - name: Django fetch_commits
        uses: garygrossgarten/github-action-ssh@release
        with:
          host: ${{ secrets.CICD_HOST }}
          username: ${{ secrets.CICD_USER }}
          password: ${{ secrets.CICD_PASS }}
          command: |
            web_pod=$(kubectl get pod -n ibs-prod | grep web | head -n 1 | cut -d ' ' -f1)
            kubectl exec -it -n ibs-prod $web_pod -- python manage.py fetch_commits
      
      # slack --> notification
      - name: Send slack when failed
        if: ${{ failure() }}                    # ì‹¤íŒ¨í–ˆì„ ë•Œ ì‹¤í–‰
        uses: ./.github/actions/slack-notify    # ì§ì ‘ 'ë§Œë“ ' Actionì´ë¯€ë¡œ uses í‚¤ì›Œë“œë¥¼ ì´ìš©í•´ì„œ ì•„ë˜ ê²½ë¡œë¥¼ ì…ë ¥í•´ì¤ë‹ˆë‹¤.
        with:
          slack_incoming_url: ${{ secrets.SLACK_INCOMING_URL }}

      - name: Send slack if completed
        if: ${{ success() }}                    # ì„±ê³µí•  ë•Œë§Œ ì‹¤í–‰
        uses: ./.github/actions/slack-notify
        with:
          status: success   # status inputì€ ë°›ëŠ” ìª½ì—ì„œ default ê°’ì„ ì •í•´ë†¨ê¸° ë•Œë¬¸ì— successì¼ ë•Œë§Œ ì „ë‹¬.
          slack_incoming_url: ${{ secrets.SLACK_INCOMING_URL }}
