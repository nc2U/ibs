name: Vue [Dev]

on:
  push:
    paths:
      - "app/vue/**"
      - ".github/workflows/vue_dev.yml"
    branches: [ "develop" ]
  
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# jobì€ ì‚¬ìš©ìê°€ ì •í•œ í”Œë«í¼ì„ í†µí•´ steps ë¼ëŠ” ì¼ë ¨ì˜ ê³¼ì •ì„ ì‹¤í–‰.
# ì—¬ëŸ¬ ê°œì˜ job ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë©°, ì—¬ëŸ¬ ê°œì˜ job ì„ ì‚¬ìš©í•  ë•ŒëŠ” ì„œë¡œ ì •ë³´ë„ êµí™˜ ê°€ëŠ¥.
# ê°ê° ë…ë¦½ì ìœ¼ë¡œë„ ì‹¤í–‰ ê°€ëŠ¥.
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    
    steps:
      # ë ˆíŒŒì§€í„°ë¦¬ ì²´í¬ ì•„ì›ƒ
      - name: Check out source code
        uses: actions/checkout@v4
        with:
          ref: 'develop'
      
      # Node.js ì‚¬ìš©
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 24
      
      # pnpm use
      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 10
          run_install: false
      
      # node_modules ìºì‹±
      - name: Cache vue node
        uses: actions/cache@v3
        id: cache_vue
        with:
          path: ./app/vue/node_modules
          key: pnpm-packages-${{ hashFiles('**/pnpm-lock.yaml') }}
      
      # node_modules ë³€í™”ê¸° ìˆìœ¼ë©´ ë¹Œë“œ
      - name: Install Dependencies
        if: steps.cache_vue.outputs.cache-hit != 'true'
        run: cd app/vue && pnpm i
      
      #      - run: pnpm lint
      #        # `if: ${{ always() }}`
      #        # ë§Œì•½ `pnpm lint`ë¼ëŠ” ê³³ì—ì„œ ì—ëŸ¬ê°€ ë‚¬ì„ ê²½ìš° ì´í›„ buildë¥¼ ì‹¤í–‰í•˜ì§€ ì•Šê³  í•´ë‹¹ workflowê°€ ì¢…ë£Œë¨.
      #        # `if: ${{ always() }}`ë¼ëŠ” ë¬¸ë²•ì„ ì‚¬ìš© ì‹œ `pnpm lint`ë¼ëŠ” ê³³ì—ì„œ ì—ëŸ¬ê°€ ë‚˜ë„
      #        # ì´í›„ì˜ buildê¹Œì§€ ë‹¤ ì‹¤í–‰ì„ í•´ë³´ê³  ë‚œ ë’¤ ì¢…ë£Œ í•˜ë¯€ë¡œ ëª¨ë“  í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ì— `if: ${{ always() }}`ë¥¼ ë¶™ì„.
      #        if: ${{ always() }}
      
      # setup and lint ì—ëŸ¬ê°€ ì—†ìœ¼ë©´ ë¹Œë“œ
      - name: Build the Source Code
        env:
          NODE_ENV: production
          BUILD_TIMESTAMP: ${{ github.run_number }}_${{ github.sha }}
        run: |
          cd app/vue
          # íƒ€ì„ìŠ¤íƒ¬í”„ ë””ë ‰í„°ë¦¬ë¡œ ë¹Œë“œ
          export BUILD_DIR="../django/static/dist_${BUILD_TIMESTAMP}"
          pnpm build

      # ë°°í¬ ë©”íƒ€ë°ì´í„° ìƒì„±
      - name: Create deployment metadata
        env:
          BUILD_TIMESTAMP: ${{ github.run_number }}_${{ github.sha }}
        run: |
          cd app/django/static
          echo "{
            \"build_time\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
            \"git_sha\": \"${{ github.sha }}\",
            \"git_branch\": \"${{ github.ref_name }}\",
            \"build_number\": \"${{ github.run_number }}\",
            \"deployer\": \"${{ github.actor }}\"
          }" > dist_${BUILD_TIMESTAMP}/deploy.json

      # ë¹Œë“œ ê²€ì¦
      - name: Verify Production Build
        env:
          BUILD_TIMESTAMP: ${{ github.run_number }}_${{ github.sha }}
        run: |
          cd app/django/static/dist_${BUILD_TIMESTAMP}

          echo "ğŸ” Verifying production build..."

          # index.html ì¡´ì¬ í™•ì¸
          if [ ! -f "index.html" ]; then
            echo "âŒ ERROR: index.html not found!"
            exit 1
          fi

          # base path ê²€ì¦ (/static/dist ê²½ë¡œ ì‚¬ìš© í™•ì¸)
          if ! grep -q '/static/dist/assets/' index.html; then
            echo "âŒ ERROR: Build base path incorrect! Expected '/static/dist/assets/'"
            echo "Found paths:"
            grep -o 'src="[^"]*"' index.html | head -5
            exit 1
          fi

          # console.log ì œê±° í™•ì¸ (ê²½ê³ ë§Œ)
          if find assets -name "*.js" -exec grep -l 'console\.log' {} \; 2>/dev/null | grep -q .; then
            echo "âš ï¸  WARNING: Console logs found in production build"
          fi

          # sourcemap ì œì™¸ í™•ì¸ (ê²½ê³ ë§Œ)
          if find assets -name "*.map" 2>/dev/null | grep -q .; then
            echo "âš ï¸  WARNING: Sourcemap files found in production build"
          fi

          echo "âœ… Production build verification passed"
          echo "ğŸ“Š Build stats:"
          echo "  - index.html: $(wc -c < index.html) bytes"
          echo "  - Total assets: $(find assets -type f | wc -l) files"
          echo "  - Total size: $(du -sh assets | cut -f1)"

      # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
      - name: Vue Unit Test using Vitest
        run: cd app/vue && pnpm test:unit

      # ìƒˆ ë¹Œë“œë§Œ ì—…ë¡œë“œ (ì „ì²´ staticì´ ì•„ë‹Œ)
      - name: Upload new build to server
        env:
          BUILD_TIMESTAMP: ${{ github.run_number }}_${{ github.sha }}
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.CICD_HOST }}
          username: ${{ secrets.CICD_USER }}
          password: ${{ secrets.CICD_PASS }}
          source: 'app/django/static/dist_${{ github.run_number }}_${{ github.sha }}'
          target: ${{ secrets.CICD_PATH }}/dev/

      # ë””ë²„ê¹…: ì—…ë¡œë“œëœ ìœ„ì¹˜ í™•ì¸
      - name: Debug uploaded location
        env:
          BUILD_TIMESTAMP: ${{ github.run_number }}_${{ github.sha }}
        uses: garygrossgarten/github-action-ssh@release
        with:
          host: ${{ secrets.CICD_HOST }}
          username: ${{ secrets.CICD_USER }}
          password: ${{ secrets.CICD_PASS }}
          command: |
            echo "ğŸ” Searching for uploaded build..."
            find ${{ secrets.CICD_PATH }}/dev -name "dist_${{ github.run_number }}_*" -type d
            echo "---"
            echo "Expected: ${{ secrets.CICD_PATH }}/dev/app/django/static/dist_${{ github.run_number }}_${{ github.sha }}"

      # SCP í›„ íŒŒì¼ ë¬´ê²°ì„± ê²€ì¦
      - name: Verify upload integrity
        env:
          BUILD_TIMESTAMP: ${{ github.run_number }}_${{ github.sha }}
        uses: garygrossgarten/github-action-ssh@release
        with:
          host: ${{ secrets.CICD_HOST }}
          username: ${{ secrets.CICD_USER }}
          password: ${{ secrets.CICD_PASS }}
          command: |
            set -e
            cd ${{ secrets.CICD_PATH }}/dev/app/django/static
            NEW_BUILD="dist_${{ github.run_number }}_${{ github.sha }}"

            echo "ğŸ” Verifying uploaded files for: $NEW_BUILD"

            test -d "$NEW_BUILD" || { echo "âŒ ERROR: Build directory not found"; exit 1; }
            test -f "$NEW_BUILD/index.html" || { echo "âŒ ERROR: index.html not uploaded"; exit 1; }
            test -d "$NEW_BUILD/assets" || { echo "âŒ ERROR: assets directory not uploaded"; exit 1; }

            ASSET_COUNT=$(find "$NEW_BUILD/assets" -type f 2>/dev/null | wc -l)
            [ "$ASSET_COUNT" -ge 10 ] || { echo "âŒ ERROR: Too few assets ($ASSET_COUNT)"; exit 1; }

            MAIN_JS=$(grep -o 'assets/index-[^"]*\.js' "$NEW_BUILD/index.html" 2>/dev/null | head -1)
            if [ -n "$MAIN_JS" ]; then
              if [ ! -f "$NEW_BUILD/$MAIN_JS" ]; then
                echo "âŒ ERROR: Referenced main JS missing: $MAIN_JS"
                exit 1
              fi
            else
              echo "âš ï¸  WARNING: Could not detect main JS reference in index.html"
            fi

            CSS_COUNT=$(find "$NEW_BUILD/assets" -name "*.css" 2>/dev/null | wc -l)
            if [ "$CSS_COUNT" -eq 0 ]; then
              echo "âŒ ERROR: No CSS files found in deployment!"
              exit 1
            fi

            echo "âœ… Upload integrity verified"
            echo "  âœ“ Main JS: $MAIN_JS"
            echo "  âœ“ CSS files: $CSS_COUNT"
            echo "  âœ“ Total assets: $ASSET_COUNT files"

      # ì›ìì  ë°°í¬ (Symlink Swap)
      - name: Atomic deployment with symlink swap
        env:
          BUILD_TIMESTAMP: ${{ github.run_number }}_${{ github.sha }}
        uses: garygrossgarten/github-action-ssh@release
        with:
          host: ${{ secrets.CICD_HOST }}
          username: ${{ secrets.CICD_USER }}
          password: ${{ secrets.CICD_PASS }}
          command: |
            cd ${{ secrets.CICD_PATH }}/dev/app/django/static

            NEW_BUILD="dist_${{ github.run_number }}_${{ github.sha }}"
            echo "ğŸ“¦ Deploying: $NEW_BUILD"

            if [ ! -d "$NEW_BUILD" ]; then
              echo "âŒ ERROR: Build directory not found: $NEW_BUILD"
              exit 1
            fi

            if [ -L "dist" ]; then
              PREVIOUS_BUILD=$(readlink dist)
              echo "Previous build: $PREVIOUS_BUILD"
            elif [ -d "dist" ]; then
              echo "âš ï¸  WARNING: dist is a directory, not a symlink. Converting to symlink..."
              PREVIOUS_BUILD=""
            fi

            # ì‹¬ë³¼ë¦­ ë§í¬ ì›ìì  êµì²´ (ë””ë ‰í„°ë¦¬ë„ ì²˜ë¦¬)
            ln -sfn "$NEW_BUILD" dist.new

            # ê¸°ì¡´ dist ë°±ì—… (ë¡¤ë°±ìš©)
            if [ -e "dist" ] || [ -L "dist" ]; then
              mv dist dist.backup
            fi

            # ìƒˆ ì‹¬ë³¼ë¦­ ë§í¬ë¥¼ distë¡œ ì´ë™
            mv dist.new dist

            if [ ! -L "dist" ]; then
              echo "âŒ ERROR: Failed to create symlink!"
              # ë¡¤ë°±
              if [ -e "dist.backup" ]; then
                mv dist.backup dist
                echo "Rolled back to previous state"
              fi
              exit 1
            fi

            CURRENT_LINK=$(readlink dist)
            if [ "$CURRENT_LINK" != "$NEW_BUILD" ]; then
              echo "âŒ ERROR: Symlink points to wrong target: $CURRENT_LINK"
              exit 1
            fi

            if [ ! -d "dist" ]; then
              echo "âŒ ERROR: Symlink is broken! Rolling back..."
              rm -f dist
              if [ -e "dist.backup" ]; then
                mv dist.backup dist
                echo "Rolled back to previous state"
              elif [ -n "$PREVIOUS_BUILD" ] && [ -d "$PREVIOUS_BUILD" ]; then
                ln -sfn "$PREVIOUS_BUILD" dist
                echo "Rolled back to: $PREVIOUS_BUILD"
              fi
              exit 1
            fi

            echo "âœ… Symlink verified: dist -> $CURRENT_LINK"

            # ë°±ì—… ì œê±° (ì„±ê³µ ì‹œ)
            rm -rf dist.backup

            echo ""
            echo "ğŸ§¹ Cleaning old builds (keeping 3 most recent)..."
            ALL_BUILDS=$(ls -dt dist_* 2>/dev/null)
            BUILD_COUNT=$(echo "$ALL_BUILDS" | wc -l)
            echo "Total builds found: $BUILD_COUNT"

            if [ "$BUILD_COUNT" -gt 3 ]; then
              echo "$ALL_BUILDS" | tail -n +4 | while read OLD_BUILD; do
                if [ "$OLD_BUILD" != "$CURRENT_LINK" ]; then
                  echo "  Removing: $OLD_BUILD"
                  rm -rf "$OLD_BUILD"
                else
                  echo "  Skipping active build: $OLD_BUILD"
                fi
              done
            fi

            echo ""
            echo "âœ… Deployment complete!"
            echo "ğŸ“Š Current state:"
            echo "  Active: $(readlink dist)"
            echo "  Remaining builds:"
            ls -lth | grep "^d" | grep "dist_" | head -5

      # NFS ë™ê¸°í™” ëŒ€ê¸°
      - name: Wait for NFS sync
        run: |
          echo "â³ Waiting for NFS synchronization..."
          sleep 5
          echo "âœ… NFS sync complete"

      # ë°°í¬ ê²€ì¦ (íŒŒì¼ ë¬´ê²°ì„± í™•ì¸)
      - name: Verify deployment integrity
        uses: garygrossgarten/github-action-ssh@release
        with:
          host: ${{ secrets.CICD_HOST }}
          username: ${{ secrets.CICD_USER }}
          password: ${{ secrets.CICD_PASS }}
          command: |
            cd ${{ secrets.CICD_PATH }}/dev/app/django/static

            echo "ğŸ” Verifying deployment integrity..."

            if [ ! -f "dist/index.html" ]; then
              echo "âŒ Deployment failed: index.html not found"
              exit 1
            fi

            if [ ! -d "dist/assets" ]; then
              echo "âŒ Deployment failed: assets directory not found"
              exit 1
            fi

            MAIN_JS=$(grep -o 'assets/index-[^"]*\.js' dist/index.html 2>/dev/null | head -1)
            if [ -n "$MAIN_JS" ]; then
              if [ ! -f "dist/$MAIN_JS" ]; then
                echo "âŒ Deployment failed: Referenced main JS missing: $MAIN_JS"
                echo "Available index JS files:"
                ls -lh dist/assets/index-*.js 2>/dev/null || echo "  None found!"
                exit 1
              fi
              echo "  âœ“ Main JS exists: $MAIN_JS"
            else
              echo "âš ï¸  WARNING: Could not detect main JS reference in index.html"
            fi

            CSS_COUNT=$(find dist/assets -name "*.css" 2>/dev/null | wc -l)
            if [ "$CSS_COUNT" -eq 0 ]; then
              echo "âŒ ERROR: No CSS files found in deployment!"
              exit 1
            fi
            echo "  âœ“ CSS files: $CSS_COUNT"

            TOTAL_ASSETS=$(find dist/assets -type f 2>/dev/null | wc -l)
            echo "  âœ“ Total assets: $TOTAL_ASSETS"

            echo ""
            echo "âœ… Deployment integrity verified"
            echo "ğŸ“Š Deployment info:"
            if [ -f "dist/deploy.json" ]; then
              cat dist/deploy.json
            fi
            echo ""
            echo "Active build: $(readlink dist)"

      # Kubernetes Pod ì¬ì‹œì‘ (Django í…œí”Œë¦¿ ìºì‹œ í´ë¦¬ì–´)
      - name: Restart web and nginx pods
        uses: garygrossgarten/github-action-ssh@release
        with:
          host: ${{ secrets.CICD_HOST }}
          username: ${{ secrets.CICD_USER }}
          password: ${{ secrets.CICD_PASS }}
          command: |
            echo "ğŸ”„ Restarting Nginx and Web pods..."
            kubectl rollout restart deployment/nginx -n ibs-dev
            kubectl rollout restart deployment/web -n ibs-dev

            echo "â³ Waiting for rollout to complete..."
            kubectl rollout status deployment/nginx -n ibs-dev --timeout=120s
            kubectl rollout status deployment/web -n ibs-dev --timeout=120s

            echo "âœ… Pods restarted successfully"

      # slack --> notification
      - name: Send slack when failed
        if: ${{ failure() }}                    # ì‹¤íŒ¨í–ˆì„ ë•Œ ì‹¤í–‰
        uses: ./.github/actions/slack-notify    # ì§ì ‘ 'ë§Œë“ ' Actionì´ë¯€ë¡œ uses í‚¤ì›Œë“œë¥¼ ì´ìš©í•´ì„œ ì•„ë˜ ê²½ë¡œë¥¼ ì…ë ¥í•´ì¤ë‹ˆë‹¤.
        with:
          slack_incoming_url: ${{ secrets.SLACK_INCOMING_URL }}

      - name: Send slack if completed
        if: ${{ success() }}                    # ì„±ê³µí•  ë•Œë§Œ ì‹¤í–‰
        uses: ./.github/actions/slack-notify
        with:
          status: success   # status inputì€ ë°›ëŠ” ìª½ì—ì„œ default ê°’ì„ ì •í•´ë†¨ê¸° ë•Œë¬¸ì— successì¼ ë•Œë§Œ ì „ë‹¬.
          slack_incoming_url: ${{ secrets.SLACK_INCOMING_URL }}
