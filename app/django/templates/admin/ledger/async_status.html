{% extends "admin/base_site.html" %}
{% load i18n admin_urls static humanize %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
&rsaquo; <a href="{% url opts|admin_urlname:'changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
&rsaquo; {{ title }}
</div>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
.progress-container {
    width: 100%;
    background-color: #f0f0f0;
    border-radius: 6px;
    padding: 3px;
    margin: 10px 0;
}

.progress-bar {
    height: 24px;
    background-color: #007cba;
    border-radius: 3px;
    text-align: center;
    line-height: 24px;
    color: white;
    font-weight: bold;
    transition: width 0.3s ease;
}

.progress-bar.success {
    background-color: #28a745;
}

.progress-bar.error {
    background-color: #dc3545;
}

.status-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin: 20px 0;
}

.info-card {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 6px;
    border-left: 4px solid #007cba;
}

.info-card h3 {
    margin: 0 0 10px 0;
    color: #333;
}

.info-card .value {
    font-size: 1.5em;
    font-weight: bold;
    color: #007cba;
}

.error-messages {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 6px;
    padding: 15px;
    margin: 20px 0;
}

.success-messages {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 6px;
    padding: 15px;
    margin: 20px 0;
}

.log-container {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 15px;
    margin: 20px 0;
    max-height: 300px;
    overflow-y: auto;
}

#status-indicator {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
    text-transform: uppercase;
    font-size: 0.8em;
}

#status-indicator.pending { background: #ffc107; color: #212529; }
#status-indicator.processing { background: #007cba; color: white; }
#status-indicator.completed { background: #28a745; color: white; }
#status-indicator.failed { background: #dc3545; color: white; }
</style>
{% endblock %}

{% block content %}

<div class="module">
    <h2>작업 정보</h2>

    <div class="form-row">
        <p><strong>작업 ID:</strong> {{ job.id }}</p>
        <p><strong>작업 유형:</strong> {{ job.get_job_type_display }}</p>
        <p><strong>리소스:</strong> {{ job.get_resource_type_display }}</p>
        <p><strong>생성일시:</strong> {{ job.created_at|date:"Y-m-d H:i:s" }}</p>
        {% if job.started_at %}
        <p><strong>시작일시:</strong> {{ job.started_at|date:"Y-m-d H:i:s" }}</p>
        {% endif %}
        {% if job.completed_at %}
        <p><strong>완료일시:</strong> {{ job.completed_at|date:"Y-m-d H:i:s" }}</p>
        {% endif %}
        {% if job.duration %}
        <p><strong>소요 시간:</strong> <span id="duration">{{ job.duration }}</span></p>
        {% endif %}
        <p><strong>상태:</strong> <span id="status-indicator" class="{{ job.status }}">{{ job.get_status_display }}</span></p>
    </div>
</div>

<div class="module">
    <h2>진행 상황</h2>

    <div class="progress-container">
        <div id="progress-bar" class="progress-bar" style="width: {{ job.progress }}%">
            <span id="progress-text">{{ job.progress }}%</span>
        </div>
    </div>

    <div class="status-info">
        <div class="info-card">
            <h3>처리된 레코드</h3>
            <div class="value" id="processed-count">{{ job.processed_records|intcomma }}</div>
        </div>

        <div class="info-card">
            <h3>전체 레코드</h3>
            <div class="value" id="total-count">{{ job.total_records|intcomma }}</div>
        </div>

        <div class="info-card">
            <h3>성공 건수</h3>
            <div class="value" id="success-count">{{ job.success_count|intcomma }}</div>
        </div>

        <div class="info-card">
            <h3>오류 건수</h3>
            <div class="value" id="error-count">{{ job.error_count|intcomma }}</div>
        </div>
    </div>
</div>

{% if job.error_message %}
<div class="module">
    <h2>오류 메시지</h2>
    <div class="error-messages">
        <pre id="error-messages">{{ job.error_message }}</pre>
    </div>
</div>
{% endif %}

{% if job.status == 'completed' %}
<div class="module">
    <h2>작업 완료</h2>
    <div class="success-messages">
        <p><strong>작업이 성공적으로 완료되었습니다!</strong></p>
        {% if job.job_type == 'import' %}
        <p>총 {{ job.processed_records|intcomma }}개의 레코드가 처리되었습니다.</p>
        {% else %}
        <p>총 {{ job.success_count|intcomma }}개의 레코드가 내보내기 되었습니다.</p>
        {% if job.result_file %}
        <p><a href="{{ job.result_file.url }}" class="button" download>결과 파일 다운로드</a></p>
        {% endif %}
        {% endif %}
    </div>
</div>
{% endif %}

<div class="module">
    <h2>작업 로그</h2>
    <div class="log-container">
        <div id="log-messages">
            <p id="current-status">상태를 확인하는 중...</p>
        </div>
    </div>
</div>

<div class="submit-row">
    <a href="{% url opts|admin_urlname:'changelist' %}" class="button">목록으로 돌아가기</a>
    {% if job.status in 'pending,processing' %}
    <button id="refresh-btn" class="default">새로고침</button>
    {% endif %}
</div>

<script>
let jobId = {{ job.id }};
let isCompleted = {% if job.status in 'completed,failed' %}true{% else %}false{% endif %};
let refreshInterval;

function updateProgress() {
    fetch(`{% url opts|admin_urlname:'async_progress' job_id=job.id %}`)
        .then(response => response.json())
        .then(data => {
            // 진행률 업데이트
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            progressBar.style.width = data.progress + '%';
            progressText.textContent = data.progress + '%';

            // 상태에 따른 색상 변경
            progressBar.className = 'progress-bar';
            if (data.status === 'completed') {
                progressBar.classList.add('success');
            } else if (data.status === 'failed') {
                progressBar.classList.add('error');
            }

            // 상태 표시기 업데이트
            const statusIndicator = document.getElementById('status-indicator');
            statusIndicator.textContent = getStatusText(data.status);
            statusIndicator.className = data.status;

            // 카운터 업데이트
            document.getElementById('processed-count').textContent = data.processed.toLocaleString();
            document.getElementById('total-count').textContent = data.total.toLocaleString();
            document.getElementById('success-count').textContent = data.success_count.toLocaleString();
            document.getElementById('error-count').textContent = data.error_count.toLocaleString();

            // 현재 상태 메시지 업데이트
            const currentStatus = document.getElementById('current-status');
            if (data.status === 'processing') {
                currentStatus.textContent = `처리 중: ${data.processed}/${data.total} (${data.progress}%)`;
            } else if (data.status === 'completed') {
                currentStatus.textContent = `완료: 총 ${data.processed}개 처리됨`;
            } else if (data.status === 'failed') {
                currentStatus.textContent = `실패: ${data.error_message || '알 수 없는 오류'}`;
            }

            // 오류 메시지 표시
            if (data.error_message) {
                const errorMessages = document.getElementById('error-messages');
                if (errorMessages) {
                    errorMessages.textContent = data.error_message;
                }
            }

            // 완료된 경우 새로고침 중지
            if (data.completed) {
                clearInterval(refreshInterval);
                isCompleted = true;

                if (data.status === 'completed') {
                    showCompletionMessage(data);
                }

                // 페이지 새로고침 (완료된 상태로 표시하기 위해)
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error updating progress:', error);
            document.getElementById('current-status').textContent = '상태 업데이트 중 오류가 발생했습니다.';
        });
}

function getStatusText(status) {
    const statusMap = {
        'pending': '대기 중',
        'processing': '처리 중',
        'completed': '완료',
        'failed': '실패'
    };
    return statusMap[status] || status;
}

function showCompletionMessage(data) {
    const logMessages = document.getElementById('log-messages');
    const completionMsg = document.createElement('div');
    completionMsg.className = 'success-messages';
    completionMsg.innerHTML = `
        <p><strong>작업이 완료되었습니다!</strong></p>
        <p>처리 시간: ${data.duration || '계산 중...'}</p>
        <p>성공: ${data.success_count}건, 오류: ${data.error_count}건</p>
    `;
    logMessages.appendChild(completionMsg);
}

// 자동 새로고침 시작
if (!isCompleted) {
    refreshInterval = setInterval(updateProgress, 2000); // 2초마다 업데이트
    updateProgress(); // 즉시 첫 업데이트
}

// 수동 새로고침 버튼
document.getElementById('refresh-btn')?.addEventListener('click', function() {
    updateProgress();
});

// 페이지 언로드 시 정리
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}